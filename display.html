<!DOCTYPE html>
<html>    
<head>
  <link rel='stylesheet' href= 'css/metronome.css'></style>
  <style>
    html{height:100%}
    body{color:white; background:black; font-size:24px; font-family:"Arial"; min-height:100%; overflow:hidden; display:flex; justify-content:center;}
    .div1{height:100vh; width:100vw; position:absolute; align-self:center; overflow:hidden; margin:0px; padding:0px; text-align:center; align-items:center; justify-content:center;}
    .div2{position:absolute; align-self:center; overflow:hidden; margin:0px; padding:0px; text-align:center; align-items:center; justify-content:center;}
    .div3{position:absolute; align-self:center; overflow:hidden; margin:0px; padding:0px; text-align:center; align-items:center; justify-content:center;}
  </style>
</head>
<body>
  <div class="div1"></div><div class="dummy"></div>
<script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-firestore.js"></script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCkLd2mVSt9UPlZtEuDw05rgEkfpPXXpBQ",
    authDomain: "agreeing-game.firebaseapp.com",
    databaseURL: "https://agreeing-game.firebaseio.com",
    projectId: "agreeing-game",
    storageBucket: "agreeing-game.appspot.com",
    messagingSenderId: "672922042579",
    appId: "1:672922042579:web:9688662e49f89090"
  };
  firebase.initializeApp(firebaseConfig);
</script>
<script src="js/jquery.min.js"></script>
<script src="js/jquery.csv.js"></script>
<script src="js/statements.js"></script>
<script src="js/spiral1.js"></script>
</body>
<script>


(function() {

  "use strict";

  let dbRoot = firebase.firestore();
  let db = dbRoot.collection('toolkit');
  let dbVisuals = db.doc('visuals');

  let div1 = document.querySelector('.div1');
  let div2 = document.querySelector('.div2');
  let div3 = document.querySelector('.div3');
  let body = document.querySelector('body');
  let mStick;
  let mContainer;
  let spiral1;
  // let metroClick = new Audio('audio/metro.wav');
  let metroClick = [
    new Audio('audio/metro.wav'),
    new Audio('audio/metro.wav')
  ];
  let visuals = {
    stim: 'None',
    speed: 0,
    delta: 0,
    colors: ['white']
  };

//   let toolStates = {spiral1: 0};
//   let flasher = {on: 0, isi: 150};
//   let dbRoot = firebase.firestore();
//   let dbVisuals = dbRoot.collection('visuals');
//   let visualActive = 'none';

  dbVisuals.onSnapshot(function(snapshot) {
    let prevVis = {};
    Object.assign(prevVis, visuals);
    Object.assign(visuals, snapshot.data());
    console.log('prev: ' + JSON.stringify(prevVis));
    // console.log('new: ' + JSON.stringify(visuals));
    if (visuals.stim != 'Metronome' && prevVis.stim == 'Metronome') {
      metroOff();
    } else if (visuals.stim != 'Spiral 1' && prevVis.stim == 'Spiral 1') {
      spiral1Off();
    }
    if (visuals.stim == 'Flasher' && prevVis.stim != 'Flasher') {
      flash();
    } else if (visuals.stim == 'Metronome') {
      if (prevVis.stim != 'Metronome') {
        metroOn();
      } else if (prevVis.speed != visuals.speed) {
        mStick.style.animation = 'metronome ' + visuals.speed/1000 + 's ease-in-out infinite alternate-reverse';
      }
    } else if (visuals.stim == 'Spiral 1' && prevVis.stim != 'Spiral 1') {
      spiral1On();
    }
  });
    // switch (visuals.stim) {
    //   case 'Flasher':
    //     if (prevVis.stim != 'Flasher') { flash(); }
    //   case 'Metronome':
    //     if (prevVis.stim != 'Metronome') {
    //       metroOn();
    //     } else if (prevVis.speed != visuals.speed) {
    //       document.getElementById('m-stick').style.animation = 'metronome ' + visuals.speed/1000 + 's ease-in-out infinite alternate-reverse';
    //     }
    // }
  // });
  //      if (change.doc.data().state) {
  //        run(change.doc.data().id);
  //      } else {
  //        end(change.doc.data().id);
  //      };
  // })});

  // function run(effect) {
  //   switch (effect) {
  //     case 'spiral1':
  //       //fx
  //       break;
  //     case 'spiral2':
  //       //fx
  //       break;
  //     case 'flasher':
  //       flasher.on = 1;
  //       flash();
  //       break;
  //     case 'metronome':
  //       //fx
  //   }
  // }

  // function end(effect) {
  //   switch (effect) {
  //     case 'spiral1':
  //       //fx
  //       break;
  //     case 'spiral2':
  //       //fx
  //       break;
  //     case 'flasher':
  //       flasher.on = 0;
  //       break;
  //     case 'metronome':
  //       //fx
  //   }
  // }

  /* 

  toolsActive.onSnapshot(function(doc) {
    let spiral1State = doc.get('spiral1');
    if (spiral1State) {
      div1.innerHTML = 'spiral';
    } else {
      div1.innerHTML = '';
    }
  });
 */
  function blink(textArray) {
    let cur = textArray.shift();
//    window.requestAnimationFrame(show, cur.text, cur.params, cur.div);
    show(cur.text, cur.params, cur.div);
//      blinkTimeout += cur.dur;
    if (textArray[0] != undefined) setTimeout(blink, cur.dur, textArray);
//    } else {
//      container1.innerHTML = '';
//      return(blinkTimeout);
  }

  function show(text, params, container) {
    if (container == undefined) container = div1;
    if (params != undefined) Object.assign(container.style, params);
    if (text != undefined) container.innerHTML = text;
  }

  function spiral1On() {
    spiral1 = document.createElement('canvas');
    spiral1.setAttribute('id', 'canvas');
    spiral1.setAttribute('width', '1920');
    spiral1.setAttribute('height', '937');
    div1.appendChild(spiral1);
    spiral1Start();
  }

  function spiral1Off() {
    spiral1.remove();
  }
 
  function flash() {
    blink([{dur: 50, params: {backgroundColor: 'white'}}, {params: {backgroundColor: 'black'}}]);
    if (visuals.stim == 'Flasher') {
      // flasher.isi = 4000/Math.pow(2, slider.valueAsNumber);
      // console.log('slider: ' + slider.valueAsNumber + '; calc: ' + 4000/Math.pow(2, slider.valueAsNumber) + '; isi: ' + flasher.isi);
      setTimeout(flash, visuals.speed);
    }
  }

  function metroOn() {
    console.log(div1.innerHTML);
    mContainer = document.createElement('div');
    mStick = document.createElement('div');
    let mBody = document.createElement('div'),
        mBase = document.createElement('div'),
        mTempo = document.createElement('div');

    mContainer.className = 'm-container';
    mBody.className = 'm-body';
    mBase.className = 'm-base';
    mTempo.className = 'm-tempo';
    mStick.className = 'm-stick';

    mBase.appendChild(mTempo);
    mBody.appendChild(mBase);
    mContainer.appendChild(mBody);
    mContainer.appendChild(mStick);
   
    body.style.background = 'radial-gradient(#777, #000 50%)';
    div1.appendChild(mContainer);

    mStick.style.animation = 'metronome ' + visuals.speed/1000 + 's ease-in-out infinite alternate-reverse';
    mStick.addEventListener('animationiteration', function() {
      metroClick[0].play();
      metroClick.push(metroClick.shift());
      //blink([{dur: 50, params: {backgroundColor: 'white'}}, {params: {backgroundColor: 'black'}}]);
    });
  }

  function metroOff() {
    mContainer.remove(); 
    body.style.background = 'black';
  }



  // flashRateInput.addEventListener('change', function() {
  //   // flasher.rate = Math.max(flashRateInput, 75);
  //   if (flashRateInput.value >= 75) {
  //     flasher.rate = flashRateInput;
  //   } else {
  //     flasher.rate = 75
  //   }
  // });
 

/*   slider.addEventListener('change', function(evt) {
    console.log(slider.value);
    flasher.dur = 7500/slider.value;
    console.log(flasher.dur);
  });
 *//* 
  addEventListener('keydown', function(evt) {
    if (evt.key == 'a') {
      flasher.on ^= 1;
      if (flasher.on) {
        div1.style.cssText = 'height:100%; width:100%; background-color:black';
//        div1.style.backgroundColor = 'white';
//        Object.assign(div1.style, testParams);
        flash();
      }
    }
  }); */


  })();
</script>